<!DOCTYPE html>
<html>
  <head>
    <title>Snake Game</title>
    
    <script src="api/jquery/jquery.min.js"></script>
    <link rel="stylesheet" href="css/game.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/snake.css">
    <link rel="stylesheet" href="css/pure.css">
    <script>
      var ws = new WebSocket('ws://128.199.124.144:8080');

      var wegGLSupportFlag = 1;
      var timer;
      var noWebGLSupportString = "<b>Sorry!!<br><br>Your browser does not have WebGL support.<br><br>Please use latest Chrome browser.<br><br><br></b>";
      var webGLSupportString = "WebGL is supported in your browser.<br><br><b>Controls:</b><br>Start/Restart: S<br>Movement: Arrow Keys<br>Pause: P<br>Resume: R<br><br><b>Loading game content, please wait..</b>";
      var animationType;
      var animationflag = 1;
      
      var loadingCount = 1;
      
      var platformCubeTexture2, platformCubeTexture, snakeCubeTexture, foodCubeTexture;
      var currentImageCount, totalImageCount;
      var gameLoadFlag = 1;
      
      var timer2;
      
      currentImageCount = 0;
      totalImageCount = 4;
      
      function initLoading(){
        clearInterval(timer);
        timer = setInterval("fadeInLoading()", 1000);
      }
      
      function fadeInLoading(){
        
          clearInterval(timer);
          animationType = "animated fadeIn";
          $("#loading").addClass(animationType);
          $("#loading").one('webkitAnimationEnd oanimationend msAnimationEnd animationend',
          function(e){
              $("#loading").removeClass(animationType);
              $("#loading").css("opacity","1.0");
              timer = setInterval("checkWebGLSupport()", 3000);
          });
      }
      
      function checkWebGLSupport(){
        clearInterval(timer);
        
        animationType = "animated fadeOut";
        $("#loading").addClass(animationType);
        $("#loading").one('webkitAnimationEnd oanimationend msAnimationEnd animationend',
        function(e){
          animationflag = 2;
          $("#loading").removeClass(animationType);
          if(window.WebGLRenderingContext){
            wegGLSupportFlag = 2;
            $("#gamehelp").html(webGLSupportString);
          }else{
            wegGLSupportFlag = 1;
            $("#gamehelp").html(noWebGLSupportString);

            $("#progressBarControl").css("display", "none");
          }
          $("#loading").addClass("animated fadeIn");
              
          if(window.WebGLRenderingContext){

        platformCubeTexture = THREE.ImageUtils.loadTexture( 'texture/crate.jpg', new THREE.UVMapping(), updateImageCount);
        platformCubeTexture2 = THREE.ImageUtils.loadTexture( 'texture/Wall_TH.jpg', new THREE.UVMapping(), updateImageCount);
        snakeCubeTexture = THREE.ImageUtils.loadTexture( 'texture/snake_skin.jpg', new THREE.UVMapping(), updateImageCount);
        snakeNextCubeTexture = THREE.ImageUtils.loadTexture( 'texture/snake2.jpg', new THREE.UVMapping(), updateImageCount);
        foodCubeTexture = THREE.ImageUtils.loadTexture( 'texture/Woodtiles_TH.jpg', new THREE.UVMapping(), updateImageCount);
        }
           
        });  
      }
      
      function updateImageCount(){       
        currentImageCount++;
        if(window.WebGLRenderingContext && currentImageCount == totalImageCount && gameLoadFlag == 1){
          clearInterval(timer2);
          timer2 = setInterval("initAll()", 10000);
        }
      }

    </script>
   <style>
        #loading {
            margin-top: 60vh;
            margin-left: 22.95vw;
            color: white;
            font-family: 'Bradley Hand ITC';
        }
        #roomrequest {
            margin-top: 0vh;
            margin-left: 35vw;
            
        }
    </style>

    <!--adhfnkdnjnfsdjnfojds-->
    <style>
        body {
            font-family: "Lato";
            background: #efecca;
            color: #1d1d1d;
            margin: 0;
            padding: 0;
        }

        .loader {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 48.2842712474619px;
            height: 48.2842712474619px;
            margin-left: -24.14213562373095px;
            margin-top: -24.14213562373095px;
            border-radius: 100%;
            -webkit-animation-name: loader;
            animation-name: loader;
            -webkit-animation-iteration-count: infinite;
            animation-iteration-count: infinite;
            -webkit-animation-timing-function: linear;
            animation-timing-function: linear;
            -webkit-animation-duration: 4s;
            animation-duration: 4s;
        }

            .loader .side {
                display: block;
                width: 6px;
                height: 20px;
                background-color: #046380;
                margin: 2px;
                position: absolute;
                border-radius: 50%;
                -webkit-animation-duration: 1.5s;
                animation-duration: 1.5s;
                -webkit-animation-iteration-count: infinite;
                animation-iteration-count: infinite;
                -webkit-animation-timing-function: ease;
                animation-timing-function: ease;
            }

                .loader .side:nth-child(1),
                .loader .side:nth-child(5) {
                    -webkit-transform: rotate(0deg);
                    -ms-transform: rotate(0deg);
                    transform: rotate(0deg);
                    -webkit-animation-name: rotate0;
                    animation-name: rotate0;
                }

                .loader .side:nth-child(3),
                .loader .side:nth-child(7) {
                    -webkit-transform: rotate(90deg);
                    -ms-transform: rotate(90deg);
                    transform: rotate(90deg);
                    -webkit-animation-name: rotate90;
                    animation-name: rotate90;
                }

                .loader .side:nth-child(2),
                .loader .side:nth-child(6) {
                    -webkit-transform: rotate(45deg);
                    -ms-transform: rotate(45deg);
                    transform: rotate(45deg);
                    -webkit-animation-name: rotate45;
                    animation-name: rotate45;
                }

                .loader .side:nth-child(4),
                .loader .side:nth-child(8) {
                    -webkit-transform: rotate(135deg);
                    -ms-transform: rotate(135deg);
                    transform: rotate(135deg);
                    -webkit-animation-name: rotate135;
                    animation-name: rotate135;
                }

                .loader .side:nth-child(1) {
                    top: 24.14213562373095px;
                    left: 48.2842712474619px;
                    margin-left: -3px;
                    margin-top: -10px;
                    -webkit-animation-delay: 0;
                    animation-delay: 0;
                }

                .loader .side:nth-child(2) {
                    top: 41.21320343109277px;
                    left: 41.21320343109277px;
                    margin-left: -3px;
                    margin-top: -10px;
                    -webkit-animation-delay: 0;
                    animation-delay: 0;
                }

                .loader .side:nth-child(3) {
                    top: 48.2842712474619px;
                    left: 24.14213562373095px;
                    margin-left: -3px;
                    margin-top: -10px;
                    -webkit-animation-delay: 0;
                    animation-delay: 0;
                }

                .loader .side:nth-child(4) {
                    top: 41.21320343109277px;
                    left: 7.07106781636913px;
                    margin-left: -3px;
                    margin-top: -10px;
                    -webkit-animation-delay: 0;
                    animation-delay: 0;
                }

                .loader .side:nth-child(5) {
                    top: 24.14213562373095px;
                    left: 0px;
                    margin-left: -3px;
                    margin-top: -10px;
                    -webkit-animation-delay: 0;
                    animation-delay: 0;
                }

                .loader .side:nth-child(6) {
                    top: 7.07106781636913px;
                    left: 7.07106781636913px;
                    margin-left: -3px;
                    margin-top: -10px;
                    -webkit-animation-delay: 0;
                    animation-delay: 0;
                }

                .loader .side:nth-child(7) {
                    top: 0px;
                    left: 24.14213562373095px;
                    margin-left: -3px;
                    margin-top: -10px;
                    -webkit-animation-delay: 0;
                    animation-delay: 0;
                }

                .loader .side:nth-child(8) {
                    top: 7.07106781636913px;
                    left: 41.21320343109277px;
                    margin-left: -3px;
                    margin-top: -10px;
                    -webkit-animation-delay: 0;
                    animation-delay: 0;
                }

        @-webkit-keyframes rotate0 {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            60% {
                -webkit-transform: rotate(180deg);
                transform: rotate(180deg);
            }

            100% {
                -webkit-transform: rotate(180deg);
                transform: rotate(180deg);
            }
        }

        @keyframes rotate0 {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            60% {
                -webkit-transform: rotate(180deg);
                transform: rotate(180deg);
            }

            100% {
                -webkit-transform: rotate(180deg);
                transform: rotate(180deg);
            }
        }

        @-webkit-keyframes rotate90 {
            0% {
                -webkit-transform: rotate(90deg);
                transform: rotate(90deg);
            }

            60% {
                -webkit-transform: rotate(270deg);
                transform: rotate(270deg);
            }

            100% {
                -webkit-transform: rotate(270deg);
                transform: rotate(270deg);
            }
        }

        @keyframes rotate90 {
            0% {
                -webkit-transform: rotate(90deg);
                transform: rotate(90deg);
            }

            60% {
                -webkit-transform: rotate(270deg);
                transform: rotate(270deg);
            }

            100% {
                -webkit-transform: rotate(270deg);
                transform: rotate(270deg);
            }
        }

        @-webkit-keyframes rotate45 {
            0% {
                -webkit-transform: rotate(45deg);
                transform: rotate(45deg);
            }

            60% {
                -webkit-transform: rotate(225deg);
                transform: rotate(225deg);
            }

            100% {
                -webkit-transform: rotate(225deg);
                transform: rotate(225deg);
            }
        }

        @keyframes rotate45 {
            0% {
                -webkit-transform: rotate(45deg);
                transform: rotate(45deg);
            }

            60% {
                -webkit-transform: rotate(225deg);
                transform: rotate(225deg);
            }

            100% {
                -webkit-transform: rotate(225deg);
                transform: rotate(225deg);
            }
        }

        @-webkit-keyframes rotate135 {
            0% {
                -webkit-transform: rotate(135deg);
                transform: rotate(135deg);
            }

            60% {
                -webkit-transform: rotate(315deg);
                transform: rotate(315deg);
            }

            100% {
                -webkit-transform: rotate(315deg);
                transform: rotate(315deg);
            }
        }

        @keyframes rotate135 {
            0% {
                -webkit-transform: rotate(135deg);
                transform: rotate(135deg);
            }

            60% {
                -webkit-transform: rotate(315deg);
                transform: rotate(315deg);
            }

            100% {
                -webkit-transform: rotate(315deg);
                transform: rotate(315deg);
            }
        }

        @-webkit-keyframes loader {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        @keyframes loader {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }
    </style>
    <style>
        html {
            background: #111;
            height: 100%;
            overflow: hidden;
        }

        .cont {
            position: absolute;
            width: 40px;
            height: 140px;
            margin: auto;
            -webkit-animation: rotate 10s linear infinite;
            animation: rotate 10s linear infinite;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
        }

            .cont:nth-child(2) {
                -webkit-animation: rotate 10s linear infinite;
                animation: rotate 10s linear infinite;
                -webkit-animation-delay: -5s;
                animation-delay: -5s;
            }

            .cont:nth-child(3) {
                -webkit-animation: rotate 10s linear infinite;
                animation: rotate 10s linear infinite;
                -webkit-animation-delay: -2.5s;
                animation-delay: -2.5s;
            }

            .cont:nth-child(4) {
                -webkit-animation: rotate 10s linear infinite;
                animation: rotate 10s linear infinite;
                -webkit-animation-delay: -7.5s;
                animation-delay: -7.5s;
            }

        .a, .b, .c, .d {
            width: 40px;
            height: 40px;
            position: absolute;
        }

            .a:after, .b:after, .c:after, .d:after {
                display: block;
                content: "";
                -webkit-transform: scale(0.5);
                -ms-transform: scale(0.5);
                transform: scale(0.5);
                width: 40px;
                height: 40px;
                border-radius: 100%;
            }

        .a {
            -webkit-animation: move 2s ease-in-out infinite alternate, zIndex 4s ease-in-out infinite;
            animation: move 2s ease-in-out infinite alternate, zIndex 4s ease-in-out infinite;
        }

        .b {
            -webkit-animation: move 2s ease-in-out infinite alternate-reverse, zIndex 4s ease-in-out infinite reverse;
            animation: move 2s ease-in-out infinite alternate-reverse, zIndex 4s ease-in-out infinite reverse;
        }

        .a:after {
            background: #75c7f0;
            -webkit-animation: zoom 2s ease-in-out infinite alternate;
            animation: zoom 2s ease-in-out infinite alternate;
            -webkit-animation-delay: -1s;
            animation-delay: -1s;
        }

        .b:after {
            background: #8152e0;
            -webkit-animation: zoom 2s ease-in-out infinite alternate-reverse;
            animation: zoom 2s ease-in-out infinite alternate-reverse;
            -webkit-animation-delay: -1s;
            animation-delay: -1s;
        }

        .c {
            -webkit-animation: move 2s ease-in-out infinite alternate, zIndex 4s ease-in-out infinite;
            animation: move 2s ease-in-out infinite alternate, zIndex 4s ease-in-out infinite;
            -webkit-animation-delay: -1s, -1s;
            animation-delay: -1s, -1s;
        }

        .d {
            -webkit-animation: move 2s ease-in-out infinite alternate-reverse, zIndex 4s ease-in-out infinite reverse;
            animation: move 2s ease-in-out infinite alternate-reverse, zIndex 4s ease-in-out infinite reverse;
            -webkit-animation-delay: -1s, -1s;
            animation-delay: -1s, -1s;
        }

        .c:after {
            background: #e05252;
            -webkit-animation: zoom 2s ease-in-out infinite alternate;
            animation: zoom 2s ease-in-out infinite alternate;
            -webkit-animation-delay: -2s;
            animation-delay: -2s;
        }

        .d:after {
            background: #f0f075;
            -webkit-animation: zoom 2s ease-in-out infinite alternate-reverse;
            animation: zoom 2s ease-in-out infinite alternate-reverse;
            -webkit-animation-delay: -2s;
            animation-delay: -2s;
        }

        @-webkit-keyframes move {
            100% {
                -webkit-transform: translateY(250%);
                transform: translateY(250%);
            }
        }

        @keyframes move {
            100% {
                -webkit-transform: translateY(250%);
                transform: translateY(250%);
            }
        }

        @-webkit-keyframes zoom {
            100% {
                -webkit-transform: scale(1);
                transform: scale(1);
            }
        }

        @keyframes zoom {
            100% {
                -webkit-transform: scale(1);
                transform: scale(1);
            }
        }

        @-webkit-keyframes zIndex {
            25% {
                z-index: 1;
            }

            75% {
                z-index: -1;
            }
        }

        @keyframes zIndex {
            25% {
                z-index: 1;
            }

            75% {
                z-index: -1;
            }
        }

        @-webkit-keyframes rotate {
            to {
                -webkit-transform: rotateZ(360deg);
                transform: rotateZ(360deg);
            }
        }

        @keyframes rotate {
            to {
                -webkit-transform: rotateZ(360deg);
                transform: rotateZ(360deg);
            }
        }
    </style>
  </head>
  <body>
    <div class="hideall" id="hideAll">
      <div class="" id="loading" style="display:none;">
            <div class="cont">
                <div class="a"></div>
                <div class="b"></div>
            </div>
            <div class="cont">
                <div class="a"></div>
                <div class="b"></div>
            </div>

            <div class="cont">
                <div class="c"></div>
                <div class="d"></div>
            </div>
            <div class="cont">
                <div class="c"></div>
                <div class="d"></div>
            </div>
            <h1 id="loading">Loading...</h1>
        </div>
        <div id="roomrequest">
            <input id="room" placeholder="Room" />
            <input id="name" placeholder="Name" />
            <button class="pure-button" onclick="start_room()">Allocate Room</button>
        </div>
    </div>
    
  
  
    <div>
    <link rel="stylesheet" href="css/animate.css">
    <script>
     function start_room(){
      var a = {type: "join", name: $("#name").val(), room: $("#room").val() };
        console.log(JSON.stringify(a));
        $("#loading").css("display",true);
        ws.send(JSON.stringify(a));
      }
    $(window).load(function() {
      localStorage.setItem("user",JSON.stringify({value:false}));
//      initLoading();
    });
     
      
    function initAll(){
      
      clearInterval(timer2);
      gameLoadFlag = 2;
      
      $("#loading").removeClass("animated fadeIn");
      
      var animationType = "animated fadeOut";
      $("#loading").addClass(animationType);
      $("#hideall").addClass(animationType);

      $("#hideAll").one('webkitAnimationEnd oanimationend msAnimationEnd animationend',
      function(e){
          $("#hideAll").removeClass(animationType);

            initUI();
            initGame();
      });

    }

      function initUI(){
        
        setOpacity($("#headersection"), "0.0");
        setOpacity($("#helpmessage"), "0.0");
        setOpacity($("#canvasframe"), "0.0");
        setOpacity($("#rightsection"), "0.0");
        setOpacity($("#leftsection"), "0.0");

        animateUI($("#hideAll"), "animated fadeOut" ,"0.0");
        animateUI($("#headersection"), "animated fadeInDown" ,"1.0");
        animateUI($("#canvasframe"), "animated fadeInUp", "1.0");
        animateUI($("#rightsection"), "animated fadeInRightBig" ,"0.7");
        animateUI($("#leftsection"), "animated fadeInLeftBig" ,"0.7");
        animateUI($("#helpmessage"), "animated fadeInUpBig" ,"0.7");
      }

      function setOpacity(iObject, opacityValue){
        iObject.css("opacity","0.0");
      }


      function animateUI(iObject, animateType, opacityValue){

        iObject.addClass(animateType);

        iObject.one('webkitAnimationEnd oanimationend msAnimationEnd animationend',
        function(e){
            iObject.removeClass(animateType);
            iObject.css("opacity",opacityValue);
            $("#helpmessage").css("opacity","0.7");
            $("#hideAll").css("display","none");
          });
      }
    </script>    

    <script src="api/jquery/jquery.min.js"></script>    
    <script src="api/threejs/three.min.js"></script>
    <script src='api/threex/THREEx.KeyboardState.js'></script>
    <script src='api/threex/THREEx.WindowResize.js'></script>
    
    <script src="api/threejs/fonts/gentilis_bold.typeface.js"></script>
    <script src="api/threejs/fonts/gentilis_regular.typeface.js"></script>
    <script src="api/threejs/fonts/optimer_bold.typeface.js"></script>
    <script src="api/threejs/fonts/optimer_regular.typeface.js"></script>
    <script src="api/threejs/fonts/helvetiker_bold.typeface.js"></script>
    <script src="api/threejs/fonts/helvetiker_regular.typeface.js"></script>
    <script src="api/threejs/fonts/droid/droid_sans_regular.typeface.js"></script>
    <script src="api/threejs/fonts/droid/droid_sans_bold.typeface.js"></script>
    <script src="api/threejs/fonts/droid/droid_serif_regular.typeface.js"></script>
    <script src="api/threejs/fonts/droid/droid_serif_bold.typeface.js"></script>
    
    <script src="api/threejs/js/libs/stats.min.js"></script>

    <script>
      var id;   
      var container;
      var stats;
      var messageBox;
      
      var camera, cameraWithSnake, scene, renderer;    
      var platformGroup, snakeGroup, snakeNextGroup, foodGroup, lightGroup;
      var lightLampGroup;
      var scoreBoardGroup, displayMenuGroup;
      var scoreNextBoardGroup;
      
      var scoreTextMesh, scoreNextTextMesh;
      
      var spotLightGroup;
      var spotLightColorArray = [0xffffff, 0xff00ff, 0xff0000, 0x00ff00];
      
      var snakeCube, platformCube;
      var tail;
      
      var row, col;
      var foodScore = 0;
      var foodNextScore = 0;
      var levelRatio = 4;
      
      var delta, timer;
      var lastKeyPressTimeStamp = 0;
      var lastNextKeyPressTimeStamp = 0;
      
      var foodCube, foodcubeMaterial;
      
      var keyPressed, keyNextPressed;
      
      var clock = new THREE.Clock();
      var platformCubeTexture;
      var platformWidth, platformHeight;
      var platformSize, snakeCubeSize;
    
      var snakeXStepSign, snakeYStepSign;
      var snakeXStep, snakeYStep, snakeZStep;
      var snakeNextXStep, snakeNextYStep, snakeNextZStep;
      
      var snake_array, snake_next_array;
      var food;
      var keyboard = new THREEx.KeyboardState();
      
      var gameStepTime = 500;
      var gameStepFlag = true;
      var pauseFlag = 0;
      var gameOverFlag = 2;
      var lastArrowKeyPressed = "right";

      var frameTime = 0; // ms
      var cumulatedFrameTime = 0; // ms
      var lastFrameTime = Date.now(); // timestamp
      
      var width = window.innerWidth || 2;
      var height = window.innerHeight || 2;

      var halfWidth = width / 2;
      var halfHeight = height / 2;
      
      var menuTextMessageMesh;
      var triggerFlag = 1;
      var alertAnimationType = "";
      var alertVisibleFlag;
      
      var gameOverString = "Game Over<br><br>Press S to Start Game";
      var gameStartString = "Press S to Start Game";
      var gameResumeString = "Press R to Resume";
      
      function triggerAnimation(animateType, visibilityFlag, messageString){
      
        triggerFlag = 0;
        messageBox.attr("class", "alertmessage");
        messageBox.addClass(animateType);
        messageBox.html(messageString);
        
        if(alertVisibleFlag == 1){
          messageBox.css("visibility","visible");
        }
        
        messageBox.one('webkitAnimationEnd oanimationend msAnimationEnd animationend',
        function(e){
            triggerFlag = 1;
            messageBox.removeClass(animateType);
            if(alertVisibleFlag == 0){
              messageBox.css("visibility","hidden");
            }
          });
      }
          
      
      // function checkKeyboardStroke(){
      //   document.onkeydown = function key_event(evt){
      //     var key = evt.keyCode;
      //     console.log
      //     if(keyboard.pressed("p") ){
      //       if(!(gameOverFlag > 0)){
      //         keyPressed = "P";
      //         keyNextPressed = "P";
      //         pauseFlag = 1;
          
      //         messageBox.css("visibility","visible");
      //         alertVisibleFlag = 1;
      //         triggerAnimation("animated bounce", 1, gameResumeString);
      //       }
            
      //     } else if(keyboard.pressed("r") ){
            
      //       if(!(gameOverFlag > 0)){
          
      //         alertVisibleFlag = 0;
      //         triggerAnimation("animated fadeOutDown", 0, gameResumeString);
      //       }
            
      //       keyPressed = lastArrowKeyPressed;
      //       keyNextPressed = lastNextArrowKeyPressed;
      //       pauseFlag = 0;
            
      //     }
      //     if(pauseFlag == 0){  
      //     if(keyboard.pressed("s") ){
        
      //         keyPressed = "right";
      //         keyNextPressed = "right";

      //         lastArrowKeyPressed = "right";
      //         lastNextArrowKeyPressed = "right";

      //         if(gameOverFlag == 1){
      //           alertVisibleFlag = 0;
      //           triggerAnimation("animated fadeOutDown", 0, gameOverString);
      //         }else{
      //           alertVisibleFlag = 0;
      //           triggerAnimation("animated fadeOutDown", 0, gameStartString);
      //         }
              
      //         var obj;
      //         for(var i = snakeGroup.children.length-1; i>=0; i--)
      //         {
      //           obj = snakeGroup.children[i];
      //           snakeGroup.remove(obj);
      //         }

      //         for(var i = snakeNextGroup.children.length-1; i>=0; i--)
      //         {
      //           obj = snakeNextGroup.children[i];
      //           snakeNextGroup.remove(obj);
      //         }
              
      //         gameStepTime = 100;
      //         foodScore = 0;
      //         foodNextScore = 0;
      //         levelRatio = 2;
      //         pauseFlag = 1;

      //         create_snake();
      //         create_next_snake();
      //         create_3D_snake();
      //         create_next_3D_snake();
      //         create_food();
              
      //         gameOverFlag = 0;
                
      //         removeScoreTextGeometry();
      //         setScoreTextGeometry(10*foodScore);
              
                
      //         pauseFlag = 0;  
      //       }
      //     }
      //     if(pauseFlag == 0)
      //     {
      //       var currentTimeStamp = Date.now();

      //       var timeStampDif = 10;
      //       var currentTimeStampDif = currentTimeStamp - lastKeyPressTimeStamp;
      //       var currentNextTimeStampDif = currentTimeStamp - lastNextKeyPressTimeStamp;
      //       if( key == 39  && keyPressed != "left" && keyPressed != "right" && currentTimeStampDif>timeStampDif){
      //         keyPressed = "right";  
      //         lastArrowKeyPressed = keyPressed;
      //         lastKeyPressTimeStamp = currentTimeStamp;
              
      //       }
      //       else if(key == 37  && keyPressed != "right" && keyPressed != "left" && currentTimeStampDif>timeStampDif){
      //         keyPressed = "left";  
      //         lastArrowKeyPressed = keyPressed;
      //         lastKeyPressTimeStamp = currentTimeStamp;
      //       }
      //       else if(key == 38  && keyPressed != "down" && keyPressed != "up" && currentTimeStampDif>timeStampDif){
      //         keyPressed = "up";  
      //         lastArrowKeyPressed = keyPressed;
      //         lastKeyPressTimeStamp = currentTimeStamp;
      //       }
      //       else if(key == 40 && keyPressed != "up" && keyPressed != "down" && currentTimeStampDif>timeStampDif){
      //         keyPressed = "down";  
      //         lastArrowKeyPressed = keyPressed;
      //         lastKeyPressTimeStamp = currentTimeStamp;
      //       }

      //       if( key == 68  && keyNextPressed != "left" && keyNextPressed != "right" && currentNextTimeStampDif>timeStampDif){
      //         keyNextPressed = "right";  
      //         lastNextArrowKeyPressed = keyNextPressed;
      //         lastNextKeyPressTimeStamp = currentTimeStamp;
              
      //       }
      //       else if(key == 65  && keyNextPressed != "right" && keyNextPressed != "left" && currentNextTimeStampDif>timeStampDif){
      //         keyNextPressed = "left";  
      //         lastNextArrowKeyPressed = keyNextPressed;
      //         lastNextKeyPressTimeStamp = currentTimeStamp;
      //       }
      //       else if(key == 87  && keyNextPressed != "down" && keyNextPressed != "up" && currentNextTimeStampDif>timeStampDif){
      //         keyNextPressed = "up";  
      //         lastNextArrowKeyPressed = keyNextPressed;
      //         lastNextKeyPressTimeStamp = currentTimeStamp;
      //       }
      //       else if(key == 88 && keyNextPressed != "up" && keyNextPressed != "down" && currentNextTimeStampDif>timeStampDif){
      //         keyNextPressed = "down";  
      //         lastNextArrowKeyPressed = keyNextPressed;
      //         lastNextKeyPressTimeStamp = currentTimeStamp;
      //       }
      //     }
          
      //     if(key) evt.preventDefault();
      //   }
      // }
      
      function create_snake(){
        var length = 5;
        snake_array = [];
        for(var i = length-1; i>=0; i--)
        {
          snake_array.push({x: i, y:0});
        }
      }

      function create_next_snake(){
        var length = 5;
        snake_next_array = [];
        for(var i = length-1; i>=0; i--)
        {
          snake_next_array.push({x: 0, y:i});
        }
      }
      
      function isEmptyCell(x, y, array){
        for(var i = 0; i < array.length; i++)
        {
          if(array[i].x == x && array[i].y == y)
           return false;
        }
        return true;
      }
      function isEmptyCellMulti(x, y, array1, array2){
        for(var i = 0; i < array1.length; i++)
        {
          if(array1[i].x == x && array1[i].y == y)
           return false;
        }
        for(var i = 0; i < array2.length; i++)
        {
          if(array2[i].x == x && array2[i].y == y)
           return false;
        }
        return true;
      }
      
      function create_food(){
        foodGroup.remove(foodGroup.children[0]);    
        var flag = true;
        while(flag)
        {
                      row = Math.round(Math.random()*(platformWidth-snakeCubeSize)/snakeCubeSize);
                      col = Math.round(Math.random()*(platformHeight-snakeCubeSize)/snakeCubeSize);
                      if(isEmptyCell(row, col, snake_array)) {
                food = {
                  x: row,
                  y: col,
                };
                
                var foodCubeGeometry = new THREE.SphereGeometry(snakeCubeSize, 20, 20);
                foodCube = new THREE.Mesh(foodCubeGeometry, foodcubeMaterial);
                foodCube.position.set( snakeCubeSize*food.x, snakeCubeSize, snakeCubeSize*food.y );
                foodCube.castShadow = true;
                foodCube.receiveShadow = true;
                foodCube.scale.x = 0.5;
                foodCube.scale.y = 0.5;
                foodCube.scale.z = 0.5;
                  foodGroup.add(foodCube);
            
                          flag = false;
                     }
             }
      }

      function create_newfood(identifier){
        // foodGroup.remove(foodGroup.children[0]);    
        var flag = true;
        while(flag)
        {
                      row = Math.round(Math.random()*(platformWidth-snakeCubeSize)/snakeCubeSize);
                      col = Math.round(Math.random()*(platformHeight-snakeCubeSize)/snakeCubeSize);
                      if(isEmptyCellMulti(row, col, snake_array, snake_next_array)) {
                food = {
                  x: row,
                  y: col,
                };
                var obj = JSON.parse(localStorage.getItem("user"));
                var a = {type:"food", room: obj.room, id: obj.id, food: food,name: obj.name, score: identifier };
                console.log(a, JSON.stringify(a));
              ws.send(JSON.stringify(a));
                // var foodCubeGeometry = new THREE.SphereGeometry(snakeCubeSize, 20, 20);
                // foodCube = new THREE.Mesh(foodCubeGeometry, foodcubeMaterial);
                // foodCube.position.set( snakeCubeSize*food.x, snakeCubeSize, snakeCubeSize*food.y );
                // foodCube.castShadow = true;
                // foodCube.receiveShadow = true;
                // foodCube.scale.x = 0.5;
                // foodCube.scale.y = 0.5;
                // foodCube.scale.z = 0.5;
                //   foodGroup.add(foodCube);
            
                          flag = false;
                          // return food;
                     }
             }
      }
      
      function setSnakeCube(){
        var tail;
        var lightLamp = lightGroup.children[0];
        
        snakeXStep = snake_array[0].x;
        snakeYStep = snake_array[0].y;

        // snakeNextXStep = snake_next_array[0].x;
        // snakeNextYStep = snake_next_array[0].y;
        
        if( keyPressed == "right"){
          snakeXStep++ ;
        
        }else if(keyPressed == "left"){
          snakeXStep-- ;
          
        }else if(keyPressed == "up"){
          snakeYStep-- ;    
              
        }else if(keyPressed == "down"){
          snakeYStep++ ;    
        
        }else if(keyPressed == "P"){
          pauseFlag = 1;
          
        }
        
        if((snakeXStep == -1
          || snakeXStep == platformWidth/snakeCubeSize
          || snakeYStep == -1
          || snakeYStep == platformHeight/snakeCubeSize
          || check_collision(snakeXStep, snakeYStep, snake_array)))
        {  
          var obj = JSON.parse(localStorage.getItem("user"));
          var objTosend = { type:"end",id: obj.id, name: obj.name, room: obj.room, killed: obj.id}
          ws.send(JSON.stringify(objTosend));
          // gameOverFlag = 1;
          // alertVisibleFlag = 1;
          // triggerAnimation("animated fadeInUp", 1, gameOverString);
          return;
        }
        
        
        if(snakeXStep == food.x && snakeYStep == food.y)
        {
          tail = {x: snakeXStep, y: snakeYStep};  
          console.log("1 -tail, foodScore", tail,foodScore);
          // create_food();

          foodScore++;
        
          var snakeCubeGeometry = new THREE.CubeGeometry(snakeCubeSize, snakeCubeSize, snakeCubeSize);
          snakeCube = new THREE.Mesh(snakeCubeGeometry, snakeMaterial);
          snakeCube.position.set( snakeCubeSize*tail.x, snakeCubeSize, snakeCubeSize*tail.y );
          snakeCube.castShadow = true;
          snakeCube.receiveShadow = true;
          snakeGroup.add(snakeCube);
      
          var obj = JSON.parse(localStorage.getItem("user"));

          removeScoreTextGeometry();
          if(obj.id == 1){
            setScoreTextGeometry(10*foodScore);
          }
          
          if(obj.id == 2){
            create_newfood(2);
            setScoreTextGeometry(10*foodNextScore);
          }
          
          
          
        }else
        {
          tail = snake_array.pop();
          console.log("1", tail);
          tail.x = snakeXStep;
          tail.y = snakeYStep;
        }
        
        snake_array.unshift(tail);
        var snakeCubeArray = snakeGroup.children;
      
        for(var i=0; i<snakeCubeArray.length; i++){
          
          var snake_position = snake_array[i];
          
          snakeCube = snakeCubeArray[i];
          var snakeCubePosition = snakeCube.position;
          snakeCubePosition.x = snakeCubeSize*snake_position.x;
          snakeCubePosition.z = snakeCubeSize*snake_position.y;
          
          snakeCube.position.set( snakeCubePosition.x, snakeCubePosition.y, snakeCubePosition.z);
        }
      }

      function setNextSnakeCube(){
        var nextTail;
        var lightLamp = lightGroup.children[0];

        snakeNextXStep = snake_next_array[0].x;
        snakeNextYStep = snake_next_array[0].y;
        
        if( keyNextPressed == "right"){
          snakeNextXStep++ ;
        
        }else if(keyNextPressed == "left"){
          snakeNextXStep-- ;
          
        }else if(keyNextPressed == "up"){
          snakeNextYStep-- ;    
              
        }else if(keyNextPressed == "down"){
          snakeNextYStep++ ;    
        
        }else if(keyNextPressed == "P"){
          pauseFlag = 1;
          
        }
        
        if((snakeNextXStep == -1
          || snakeNextXStep == platformWidth/snakeCubeSize
          || snakeNextYStep == -1
          || snakeNextYStep == platformHeight/snakeCubeSize
          || check_collision(snakeNextXStep, snakeNextYStep, snake_next_array)))
        {  
          var obj = JSON.parse(localStorage.getItem("user"));
          var objTosend = { type:"end",id: obj.id, name: obj.name, room: obj.room, killed: !(obj.id-1)+1}
          ws.send(JSON.stringify(objTosend));

          // gameOverFlag = 1;
          // alertVisibleFlag = 1;
          // triggerAnimation("animated fadeInUp", 1, gameOverString);
          return;
        }
        
        
        if(snakeNextXStep == food.x && snakeNextYStep == food.y)
        {
          nextTail = {x: snakeNextXStep, y: snakeNextYStep};  
          // create_food();
          console.log("2", nextTail);
          var obj = JSON.parse(localStorage.getItem("user"));
          foodNextScore++;
        
          var snakeCubeGeometry = new THREE.CubeGeometry(snakeCubeSize, snakeCubeSize, snakeCubeSize);
          snakeCube = new THREE.Mesh(snakeCubeGeometry, snakeNextMaterial);
          snakeCube.position.set( snakeCubeSize*nextTail.x, snakeCubeSize, snakeCubeSize*nextTail.y );
          snakeCube.castShadow = true;
          snakeCube.receiveShadow = true;
          snakeNextGroup.add(snakeCube);
      
          removeNextScoreTextGeometry();
          var obj = JSON.parse(localStorage.getItem("user"));
          if(obj.id == 1)
          setNextScoreTextGeometry(10*foodNextScore);
          else
            setNextScoreTextGeometry(10*foodScore);

          if(obj.id == 2)
          create_newfood(1);
          
          
          
        }else
        {
          nextTail = snake_next_array.pop();
          console.log("2", nextTail);
          nextTail.x = snakeNextXStep;
          nextTail.y = snakeNextYStep;
        }
        
        snake_next_array.unshift(nextTail);
        var snakeCubeArray = snakeNextGroup.children;
      
        for(var i=0; i<snakeCubeArray.length; i++){
          
          var snake_position = snake_next_array[i];
          
          snakeCube = snakeCubeArray[i];
          var snakeCubePosition = snakeCube.position;
          snakeCubePosition.x = snakeCubeSize*snake_position.x;
          snakeCubePosition.z = snakeCubeSize*snake_position.y;
          
          snakeCube.position.set( snakeCubePosition.x, snakeCubePosition.y, snakeCubePosition.z);
        }
      }
      
      function check_collision(x, y, array){
        
        for(var i = 0; i < array.length; i++)
        {
          if(array[i].x == x && array[i].y == y)
           return true;
        }
        return false;
      }
      
      function create_3D_snake(){
      
        snakeMaterial = new THREE.MeshLambertMaterial({ map: snakeCubeTexture });
        var snakeCubeGeometry = new THREE.CubeGeometry(snakeCubeSize, snakeCubeSize, snakeCubeSize);
        for(var i=snake_array.length-1; i>=0; i--){
          var snake_position = snake_array[i];
          snakeCube = new THREE.Mesh(snakeCubeGeometry, snakeMaterial);
          snakeCube.position.set( snakeCubeSize*snake_position.x, snakeCubeSize, snakeCubeSize*snake_position.y );
          snakeCube.castShadow = true;
          snakeCube.receiveShadow = true;
          snakeGroup.add(snakeCube);
        }
      }

      function create_next_3D_snake(){
      
        snakeNextMaterial = new THREE.MeshLambertMaterial({ map: snakeNextCubeTexture });
        var snakeCubeGeometry = new THREE.CubeGeometry(snakeCubeSize, snakeCubeSize, snakeCubeSize);
        for(var i=snake_next_array.length-1; i>=0; i--){
          var snake_position = snake_next_array[i];
          snakeCube = new THREE.Mesh(snakeCubeGeometry, snakeNextMaterial);
          snakeCube.position.set( snakeCubeSize*snake_position.x, snakeCubeSize, snakeCubeSize*snake_position.y );
          snakeCube.castShadow = true;
          snakeCube.receiveShadow = true;
          snakeNextGroup.add(snakeCube);
        }
      }
    
      function initGame(){
        
        container = $( "#canvasframe" )[0];
        messageBox = $("#helpmessage");
      
        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.left = '10px';
        stats.domElement.style.top = '390px';
        //container.appendChild(stats.domElement);
        
        platformWidth = 300;
        platformHeight = 300;
        platformSize = 300;
        snakeCubeSize = 10;
        
        snakeXStepSign = 1;
        snakeYStepSign = 0;
        
        create_snake();
        create_next_snake();
        
        snakeMaterial = new THREE.MeshLambertMaterial({ map: snakeCubeTexture });
        snakeNextMaterial = new THREE.MeshLambertMaterial({ map: snakeNextCubeTexture });
        
        foodcubeMaterial = new THREE.MeshLambertMaterial({ map: foodCubeTexture });

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        scene.position.set( platformWidth/2, platformHeight/2, 0 );
        
        cameraWithSnake = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        
        camera.position.set( platformWidth/2-4, platformHeight/2, platformSize*3/2.6);
        camera.rotation.x += degToRad(-45);
      
        renderer = new THREE.WebGLRenderer({canvas:container, antialias:true});
        
        renderer.setSize($( "#canvasframe" ).width(), $( "#canvasframe" ).height());
        renderer.shadowMapEnabled = true;
        
        renderer.setClearColor(0xffffff, 0.7);
        
        platformGroup = new THREE.Object3D();
        scene.add( platformGroup );
        
        scoreBoardGroup = new THREE.Object3D();
        scene.add( scoreBoardGroup );

        scoreNextBoardGroup = new THREE.Object3D();
        scene.add( scoreNextBoardGroup );
        
        snakeGroup = new THREE.Object3D();
        scene.add( snakeGroup );

        snakeNextGroup = new THREE.Object3D();
        scene.add( snakeNextGroup );
        
        foodGroup = new THREE.Object3D();
        scene.add( foodGroup );
        
        lightGroup = new THREE.Object3D();
        scene.add( lightGroup );
        
        spotLightGroup = new THREE.Object3D();
        scene.add( spotLightGroup );
      
        var platformMaterial = new THREE.MeshLambertMaterial({ map: platformCubeTexture });
        var platformMaterial2 = new THREE.MeshLambertMaterial({ map: platformCubeTexture2 });
        var platformCubeGeometry = new THREE.CubeGeometry(snakeCubeSize, snakeCubeSize, snakeCubeSize);
        var platformPlaneGeometry = new THREE.PlaneGeometry(snakeCubeSize, snakeCubeSize  );
        
        createScoreBoard();
      
        for(var i=0; i<(platformWidth/snakeCubeSize); i++){
          for(var j=0; j<(platformHeight/snakeCubeSize); j++){
            
            platformCube = new THREE.Mesh(platformPlaneGeometry, platformMaterial);
          
            platformCube.position.set( snakeCubeSize*i, 5, snakeCubeSize*j );
            platformCube.rotation.x = - Math.PI / 2;
            
            platformCube.receiveShadow = true;
              platformGroup.add(platformCube);
          }
        }
        
        for(var i=0; i<(platformWidth/snakeCubeSize); i++){
          for(var j=0; j<2; j++){
            platformCube = new THREE.Mesh(platformCubeGeometry, platformMaterial2);
            platformCube.position.set( snakeCubeSize*i, snakeCubeSize, -snakeCubeSize+(platformHeight+snakeCubeSize)*j);
            platformCube.castShadow = true;
            platformCube.receiveShadow = true;
              platformGroup.add(platformCube);
          }
        }
        
        for(var i=0; i<(platformHeight/snakeCubeSize); i++){
          for(var j=0; j<2; j++){
            platformCube = new THREE.Mesh(platformCubeGeometry, platformMaterial2);
            platformCube.position.set( -snakeCubeSize+(platformWidth+snakeCubeSize)*j, snakeCubeSize, snakeCubeSize*i);
            platformCube.castShadow = true;
            platformCube.receiveShadow = true;
              platformGroup.add(platformCube);
          }
        }
        
        create_3D_snake();
        create_next_3D_snake();
              
        create_food();

        var obj = JSON.parse(localStorage.getItem("user"));
        if(obj.id == 2)
        create_newfood(-1);
      
              var ambientLight = new THREE.AmbientLight(0xcccccc);
               scene.add(ambientLight);
                
              var directionalLight = new THREE.DirectionalLight(0xffffff);
              directionalLight.position.set(platformWidth/2, platformHeight, 60).normalize();
        
        var spotLight = new THREE.SpotLight( 0xffffff );
        spotLight.position.set( platformWidth*2, platformHeight*1.6, platformSize*2 );
        spotLight.castShadow = true;
        
        scene.add(spotLight);      
        THREEx.WindowResize(renderer, camera);
        
        window.onblur = function() {
          if(!(gameOverFlag > 0)){
            keyPressed = "P";
            pauseFlag = 1;
            // render();
            
            alertVisibleFlag = 1;
            triggerAnimation("animated bounce", 1, gameResumeString);
          }
          
        };
        
        animate();
        
      }
      
      function createScoreBoard(){
        var scoreStandMaterial = new THREE.MeshLambertMaterial({ map: platformCubeTexture });
        var scoreStandCubeGeometry = new THREE.CubeGeometry(snakeCubeSize, snakeCubeSize, snakeCubeSize);
        
        var scoreStandCube;
        
        for(var i=1; i<4; i+=2){
          scoreStandCube = new THREE.Mesh(scoreStandCubeGeometry, scoreStandMaterial);
          scoreStandCube.position.set(i*platformWidth/4-snakeCubeSize, snakeCubeSize*2, -snakeCubeSize);
          scoreStandCube.castShadow = true;
          scoreStandCube.receiveShadow = true;
            scoreBoardGroup.add(scoreStandCube);
        }
        
        var scorePlatformWidth = platformWidth/1.5;
        
        var scorePlatformMaterial = new THREE.MeshLambertMaterial({ map: platformCubeTexture });
        var scorePlatformCubeGeometry = new THREE.CubeGeometry(scorePlatformWidth, snakeCubeSize/2, snakeCubeSize);
        
        var scorePlatformCube;
        scorePlatformCube = new THREE.Mesh(scorePlatformCubeGeometry, scorePlatformMaterial);
        scorePlatformCube.position.set((platformWidth-scorePlatformWidth)*3/2-snakeCubeSize, snakeCubeSize*2.8, -snakeCubeSize);
        scorePlatformCube.castShadow = true;
        scorePlatformCube.receiveShadow = true;
          scoreBoardGroup.add(scorePlatformCube);

        setScoreTextLabelGeometry();
        //setNextScoreTextLabelGeometry();
        setScoreTextGeometry(foodScore);
        setNextScoreTextGeometry(foodNextScore);
      }
      
      function setScoreTextLabelGeometry(){
        
          var scorePlatformWidth = platformWidth/1.5;
          var textMaterial = new THREE.MeshBasicMaterial({ color: 0x00bbbb });
                    
          scoreTextMesh = new THREE.Mesh( getTextGeometry("Score", "gentilis"), textMaterial );
          scoreTextMesh.castShadow = true;
          scoreTextMesh.receiveShadow = true;
          scoreTextMesh.position.set((platformWidth-scorePlatformWidth)*3/2-snakeCubeSize*3, snakeCubeSize*3.2, -snakeCubeSize);
          scoreBoardGroup.add(scoreTextMesh);
      }

      function setScoreTextGeometry(scoreString){
        
          var scorePlatformWidth = platformWidth/1.5;
          var textMaterial = new THREE.MeshBasicMaterial({ color: 0x00cc00 });
          
          scoreTextMesh = new THREE.Mesh( getTextGeometry(scoreString, "gentilis"), textMaterial );
          scoreTextMesh.castShadow = true;
          scoreTextMesh.receiveShadow = true;
          scoreTextMesh.position.set((platformWidth-scorePlatformWidth)*3/2-snakeCubeSize*6, snakeCubeSize*3.2, -snakeCubeSize);
          scoreBoardGroup.add(scoreTextMesh);
      }
      
      function setNextScoreTextGeometry(scoreString){
        
          var scorePlatformWidth = platformWidth/1.5;
          var textMaterial = new THREE.MeshBasicMaterial({ color: 0x00cc00 });
          
          scoreNextTextMesh = new THREE.Mesh( getTextGeometry(scoreString, "gentilis"), textMaterial );
          scoreNextTextMesh.castShadow = true;
          scoreNextTextMesh.receiveShadow = true;
          scoreNextTextMesh.position.set((platformWidth-scorePlatformWidth)*3/2+snakeCubeSize*4, snakeCubeSize*3.2, -snakeCubeSize);
          scoreBoardGroup.add(scoreNextTextMesh);
      }

      function removeScoreTextGeometry(){
        scoreBoardGroup.remove( scoreTextMesh );
      }
      function removeNextScoreTextGeometry(){
        scoreBoardGroup.remove( scoreNextTextMesh );
      }

      function getTextGeometry(textStr, fontType){
        var textGeometry = new THREE.TextGeometry(textStr, {

          size: 17,
          height: 3,
          curveSegments: 1,

          font: fontType,
          weight: "normal",
          style: "normal",

          bevelThickness: 1,
          bevelSize: 1,
          bevelEnabled: true

        });
        return textGeometry;
      }
      
      function getTextGeometryWithSize(textStr, fontType, fontSize){
        var textGeometry = new THREE.TextGeometry(textStr, {

          size: fontSize,
          height: 1,
          curveSegments: 0,

          font: fontType,
          weight: "normal",
          style: "normal",

          bevelThickness: 1,
          bevelSize: 0.3,
          bevelEnabled: true

        });
        return textGeometry;
      }
      
      
      function checkLevelRatio(){
        
        if((foodScore % levelRatio == 0) && foodScore!=0 && gameStepFlag==true){
          gameStepTime -= levelRatio;
          gameStepFlag = false;
        }
        
        if(foodScore % levelRatio != 0){
          gameStepFlag = true;
        }
        
        if(gameStepTime <= 0){
          gameStepTime = 0;
        }
      }
      
      function animate() {
        requestAnimationFrame( animate );
        // render();
      //  checkKeyboardStroke();
        stats.update();
      }
      
      
      function render(){
                
        delta = clock.getDelta();
        
        var time = Date.now();
        
        frameTime = time - lastFrameTime;
        if(frameTime >= gameStepTime){
          
          if(pauseFlag==0 && gameOverFlag==0){
            setSnakeCube();
            setNextSnakeCube();
            checkLevelRatio();
          }
          
          cumulatedFrameTime = 0;
          lastFrameTime = time;
          
        }
        rotateFood();
        renderer.render(scene, camera);
      }
      
      function rotateFood(){
        foodCube.rotation.y += 0.1;
      }
      
      function degToRad(angle){
        return angle*Math.PI/180.00;
      }
      
      function radToDeg(angle){
        return angle*180.00/Math.PI;
      }
  

    </script>
  
     <canvas id="canvasframe" class="renderframe"></canvas>
    <div class="sectionBox" id="leftsection"><b>Controls:</b><br>Start/Restart: S<br>Movement: Arrow Keys<br>Pause: P<br>Resume: R<br><br><b>API:</b><br>
         <button  class="pure-button" onclick="sendmessage()">SEND M</button></div>
            
    <div class="alertmessage" id="helpmessage">Waiting for another player to continue</div>
    <header id="headersection">Simple 3D Snake Game</header>
    </div>
    <script>
      document.onkeydown = function key_event(evt){
        var key = evt.keyCode;
        var obj = JSON.parse(localStorage.getItem("user"));
        if(obj.value){
          if(obj.id == 1){
            ws.send(JSON.stringify({type:"move",room:obj.room,snake:snake_array,move:key,name:obj.name, id:obj.id  }));
          } else if(obj.id == 2){
            ws.send(JSON.stringify({type:"move",room:obj.room,snake:snake_next_array,move:key,name:obj.name, id:obj.id  }));
          } 
        }
      }
      ws.onmessage = function (event) {
        console.log(event);
        var data = JSON.parse(event.data)
        if(data.type == "move"){
          var key = data.move ;
          var id = data.id ;
          if(key == 80 ){           //P
            if(!(gameOverFlag > 0)){
              keyPressed = "P";
              keyNextPressed = "P";
              pauseFlag = 1;
          
              messageBox.css("visibility","visible");
              alertVisibleFlag = 1;
              triggerAnimation("animated bounce", 1, gameResumeString);
            }
            
          } else if(key == 82 ){        //R
            
            if(!(gameOverFlag > 0)){
          
              alertVisibleFlag = 0;
              triggerAnimation("animated fadeOutDown", 0, gameResumeString);
            }
            
            keyPressed = lastArrowKeyPressed;
            keyNextPressed = lastNextArrowKeyPressed;
            pauseFlag = 0;
            
          }
          if(pauseFlag == 0){  
            if(key == 83 ){
        
              keyPressed = "right";
              keyNextPressed = "right";

              lastArrowKeyPressed = "right";
              lastNextArrowKeyPressed = "right";

              if(gameOverFlag == 1){
                alertVisibleFlag = 0;
                triggerAnimation("animated fadeOutDown", 0, gameOverString);
              }else{
                alertVisibleFlag = 0;
                triggerAnimation("animated fadeOutDown", 0, "Waiting for another player. Have patience.");
              }
              
              var obj;
              for(var i = snakeGroup.children.length-1; i>=0; i--)
              {
                obj = snakeGroup.children[i];
                snakeGroup.remove(obj);
              }

              for(var i = snakeNextGroup.children.length-1; i>=0; i--)
              {
                obj = snakeNextGroup.children[i];
                snakeNextGroup.remove(obj);
              }
              
              gameStepTime = 100;
              foodScore = 0;
              foodNextScore = 0;
              levelRatio = 2;
              pauseFlag = 1;

              create_snake();
              create_next_snake();
              create_3D_snake();
              create_next_3D_snake();
              // create_food();
              var obj = JSON.parse(localStorage.getItem("user"));
              if(obj.id == 2)
              create_newfood(-1);

              gameOverFlag = 0;
                
              removeScoreTextGeometry();
              setScoreTextGeometry(10*foodScore);
              removeNextScoreTextGeometry();
              setNextScoreTextGeometry(10*foodNextScore);
              
                
              pauseFlag = 0;  
            }
          }

          console.log(id);
          if(pauseFlag == 0)
          {
            var currentTimeStamp = Date.now();
            var timeStampDif = 10;

            if(id == 1){
              var currentTimeStampDif = currentTimeStamp - lastKeyPressTimeStamp;
              if( key == 39  && keyPressed != "left" && keyPressed != "right" && currentTimeStampDif>timeStampDif){
                //snake_array = data.snake;
                // snake_array[0] = data.snake[0];
                // setSnakeCube();
                // setNextSnakeCube();
                keyPressed = "right";  
                lastArrowKeyPressed = keyPressed;
                lastKeyPressTimeStamp = currentTimeStamp;
                
              }
              else if(key == 37  && keyPressed != "right" && keyPressed != "left" && currentTimeStampDif>timeStampDif){
                //snake_array = data.snake;
                // snake_array[0] = data.snake[0];
                // setSnakeCube();
                // setNextSnakeCube();
                keyPressed = "left";  
                lastArrowKeyPressed = keyPressed;
                lastKeyPressTimeStamp = currentTimeStamp;
              }
              else if(key == 38  && keyPressed != "down" && keyPressed != "up" && currentTimeStampDif>timeStampDif){
                //snake_array = data.snake;
                // snake_array[0] = data.snake[0];
                // setSnakeCube();
                // setNextSnakeCube();
                keyPressed = "up";  
                lastArrowKeyPressed = keyPressed;
                lastKeyPressTimeStamp = currentTimeStamp;
              }
              else if(key == 40 && keyPressed != "up" && keyPressed != "down" && currentTimeStampDif>timeStampDif){
                //snake_array = data.snake;
                // snake_array[0] = data.snake[0];
                // setSnakeCube();
                // setNextSnakeCube();
                keyPressed = "down";  
                lastArrowKeyPressed = keyPressed;
                lastKeyPressTimeStamp = currentTimeStamp;
              }
            } else if(id == 2){ 
                
                var currentNextTimeStampDif = currentTimeStamp - lastNextKeyPressTimeStamp;
                if( key == 39  && keyNextPressed != "left" && keyNextPressed != "right" && currentNextTimeStampDif>timeStampDif){
                  // snake_next_array = data.snake;
                //   snake_next_array[0] = data.snake[0];
                //   setSnakeCube();
                // setNextSnakeCube();
                  keyNextPressed = "right";  
                  lastNextArrowKeyPressed = keyNextPressed;
                  lastNextKeyPressTimeStamp = currentTimeStamp;
                  
                }
                else if(key == 37  && keyNextPressed != "right" && keyNextPressed != "left" && currentNextTimeStampDif>timeStampDif){
                  // snake_next_array = data.snake;
                  // snake_next_array[0] = data.snake[0];
                  // setSnakeCube();
                  // setNextSnakeCube();
                  keyNextPressed = "left";  
                  lastNextArrowKeyPressed = keyNextPressed;
                  lastNextKeyPressTimeStamp = currentTimeStamp;
                }
                else if(key == 38  && keyNextPressed != "down" && keyNextPressed != "up" && currentNextTimeStampDif>timeStampDif){
                  // snake_next_array = data.snake;
                  // snake_next_array[0] = data.snake[0];
                  // setSnakeCube();
                  // setNextSnakeCube();
                  keyNextPressed = "up";  
                  lastNextArrowKeyPressed = keyNextPressed;
                  lastNextKeyPressTimeStamp = currentTimeStamp;
                }
                else if(key == 40 && keyNextPressed != "up" && keyNextPressed != "down" && currentNextTimeStampDif>timeStampDif){
                  // snake_next_array = data.snake;
                  // snake_next_array[0] = data.snake[0];
                  // setSnakeCube();
                  // setNextSnakeCube();
                  keyNextPressed = "down";  
                  lastNextArrowKeyPressed = keyNextPressed;
                  lastNextKeyPressTimeStamp = currentTimeStamp;
                }
              }
          }
        }
        else if(data.type == "setid"){
          localStorage.clear();
          localStorage.setItem("user", JSON.stringify({id : data.id, name: data.name, room : data.room, value:true}));
          $("#start").css("display", "none");
          initLoading();
        } else if(data.type == "food"){
          var food = data.food;
          foodGroup.remove(foodGroup.children[0]); 
          var foodCubeGeometry = new THREE.SphereGeometry(snakeCubeSize, 20, 20);
          foodCube = new THREE.Mesh(foodCubeGeometry, foodcubeMaterial);
          foodCube.position.set( snakeCubeSize*food.x, snakeCubeSize, snakeCubeSize*food.y );
          foodCube.castShadow = true;
          foodCube.receiveShadow = true;
          foodCube.scale.x = 0.5;
          foodCube.scale.y = 0.5;
          foodCube.scale.z = 0.5;
          foodGroup.add(foodCube);

          removeScoreTextGeometry();
          setScoreTextGeometry(10*data.score[1]);
          removeNextScoreTextGeometry();
          setNextScoreTextGeometry(10*data.score[0]);
        } else if(data.type == "render"){
            if(pauseFlag==0 && gameOverFlag==0){
            setSnakeCube();
            setNextSnakeCube();
            checkLevelRatio();
          }
          console.log(foodScore);
          
          // removeScoreTextGeometry();
          //     setScoreTextGeometry(10*foodScore);
          //     removeNextScoreTextGeometry();
          //     setNextScoreTextGeometry(10*foodNextScore);
          // cumulatedFrameTime = 0;
          // lastFrameTime = time;
          rotateFood();
          renderer.render(scene, camera);
        } else if(data.type == "end"){
          var sc = [];
          gameOverFlag = 1;
          alertVisibleFlag = 1;
          var obj = JSON.parse(localStorage.getItem("user"));
          if(obj.id==1){
          sc[1] = data.score[0];
          sc[0] = data.score[1];
        } else{
          sc[0] = data.score[0];
          sc[1] = data.score[1];
        }
          
          var killed = data.killed;
          console.log(killed);
          sc[!(killed-1)] = sc[!(killed-1)] -5;
          
          if(sc[1]>sc[0]){
            console.log("2 wins");
            if(obj.id==1)
            triggerAnimation("animated fadeInUp", 1, "You Lose");
            if(obj.id==2)
            triggerAnimation("animated fadeInUp", 1, "You Wins");
          } else{
            console.log("1 wins");
            if(obj.id==1)
            triggerAnimation("animated fadeInUp", 1, "You wins");
            if(obj.id==2)
            triggerAnimation("animated fadeInUp", 1, "You Lose");
          }

          
        } else if(data.type == "length"){
          snakeNextXStep = snake_next_array[0].x;
          snakeNextYStep = snake_next_array[0].y;
          nextTail = {x: snakeNextXStep, y: snakeNextYStep};  
          var snakeCubeGeometry = new THREE.CubeGeometry(snakeCubeSize, snakeCubeSize, snakeCubeSize);
          snakeCube = new THREE.Mesh(snakeCubeGeometry, snakeNextMaterial);
          snakeCube.position.set( snakeCubeSize*nextTail.x, snakeCubeSize, snakeCubeSize*nextTail.y );
          snakeCube.castShadow = true;
          snakeCube.receiveShadow = true;
          snakeNextGroup.add(snakeCube);

          snake_next_array.unshift(nextTail);
        var snakeCubeArray = snakeNextGroup.children;
      
        for(var i=0; i<snakeCubeArray.length; i++){
          
          var snake_position = snake_next_array[i];
          
          snakeCube = snakeCubeArray[i];
          var snakeCubePosition = snakeCube.position;
          snakeCubePosition.x = snakeCubeSize*snake_position.x;
          snakeCubePosition.z = snakeCubeSize*snake_position.y;
          
          snakeCube.position.set( snakeCubePosition.x, snakeCubePosition.y, snakeCubePosition.z);

        }

          snakeXStep = snake_array[0].x;
          snakeYStep = snake_array[0].y;
          tail = {x: snakeXStep, y: snakeYStep}; 
          var snakeCubeGeometry = new THREE.CubeGeometry(snakeCubeSize, snakeCubeSize, snakeCubeSize);
          snakeCube = new THREE.Mesh(snakeCubeGeometry, snakeMaterial);
          snakeCube.position.set( snakeCubeSize*tail.x, snakeCubeSize, snakeCubeSize*tail.y );
          snakeCube.castShadow = true;
          snakeCube.receiveShadow = true;
          snakeGroup.add(snakeCube);

          snake_array.unshift(tail);
        var snakeCubeArray = snakeGroup.children;
      
        for(var i=0; i<snakeCubeArray.length; i++){
          
          var snake_position = snake_array[i];
          
          snakeCube = snakeCubeArray[i];
          var snakeCubePosition = snakeCube.position;
          snakeCubePosition.x = snakeCubeSize*snake_position.x;
          snakeCubePosition.z = snakeCubeSize*snake_position.y;
          
          snakeCube.position.set( snakeCubePosition.x, snakeCubePosition.y, snakeCubePosition.z);
        }

        }

      };
      //console.log("1");
    </script>
  </body>
</html>